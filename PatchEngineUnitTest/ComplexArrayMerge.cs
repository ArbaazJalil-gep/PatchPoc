using Newtonsoft.Json.Linq;
using PatchEngine.Core;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace PatchEngineUnitTest
{
    public class ComplexArrayMerge
    {
        [Fact]
        public void TestMergeComplex()
        {
            // Arrange
            var objParsed = JObject.Parse("{\n      \"left\":{\n    \"Id\": 1,\n    \"widgetManager\": {\n        \"Id\": \"widgetManager1\",\n        \"layout\": \"12\",\n        \"widgets\": [\n            {\n                \"Id\": \"widget-16784476843\",\n                \"title\": \"First\",\n                \"behaviour\": {\n                    \"Id\": \"000\",\n                    \"isVisible\": true,\n                    \"isDraggable\": \"yes\"\n                }\n            },\n            {\n                \"Id\": \"widget-000000001\",\n                \"title\": \"Should GetMerged\",\n                \"behaviour\": {\n                    \"Id\": \"behaviour1\",\n                    \"isVisible\": true,\n                    \"isDraggable\": \"no\",\n                    \"extraPropertyInLeft\": \"yep i am extra\"\n                }\n            }\n        ]\n    },\n    \"children\": [\n        {\n            \"isVisible\": true,\n            \"type\": \"text\",\n            \"Id\": \"widget-16784476843-field-16784479250\",\n            \"label\": \"Field Name\",\n            \"behaviour\": {\n                \"Id\": \"behavior1\",\n                \"autoRender\": false\n            },\n            \"attributes\": {\n                \"Id\": \"attributes1\",\n                \"disable\": false,\n                \"textAlign\": \"left\"\n            }\n        }\n    ],\n    \"breadCrumb\": {\n        \"Id\": \"breadCrumb1\",\n        \"navigation\": {\n            \"Id\": \"navigation1\",\n            \"sections\": [\n                {\n                    \"Id\": \"sections1\",\n                    \"routePath\": \"#\",\n                    \"title\": \"untitled\",\n                    \"emitEvent\": false\n                }\n            ]\n        },\n        \"heading\": {\n            \"Id\": \"heading1\",\n            \"title\": \"Untitled\",\n            \"secondaryTitle\": \"SecondTitle\"\n        }\n    }\n},\n    \"selected\":[\n    {\n        \"Path\": \"widgetManager.layout\",\n        \"LeftValue\": \"12\",\n        \"RightValue\": \"13\"\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-16784476843.title\",\n        \"LeftValue\": \"First\",\n        \"RightValue\": \"A\"\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-000000001\",\n        \"LeftValue\": {\n            \"Id\": \"widget-000000001\",\n            \"title\": \"Should GetMerged\",\n            \"behaviour\": {\n                \"Id\": \"behaviour1\",\n                \"isVisible\": true,\n                \"isDraggable\": \"no\",\n                \"extraPropertyInLeft\": \"yep i am extra\"\n            }\n        },\n        \"RightValue\": null\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-22224476843\",\n        \"LeftValue\": null,\n        \"RightValue\": {\n            \"Id\": \"widget-22224476843\",\n            \"title\": \"B\",\n            \"behaviour\": {\n                \"Id\": \"behaviour2\",\n                \"isVisible\": true,\n                \"isDraggable\": \"no\"\n            }\n        }\n    },\n    {\n        \"Path\": \"children:widget-16784476843-field-16784479250.label\",\n        \"LeftValue\": \"Field Name\",\n        \"RightValue\": \"New Field Name\"\n    },\n    {\n        \"Path\": \"children:widget-16784476843-field-16784479250.behaviour.autoRender\",\n        \"LeftValue\": false,\n        \"RightValue\": true\n    },\n    {\n        \"Path\": \"children:widget-16784476843-field-16784479250.attributes.textAlign\",\n        \"LeftValue\": \"left\",\n        \"RightValue\": \"right\"\n    },\n    {\n        \"Path\": \"breadCrumb.navigation.sections:sections1.title\",\n        \"LeftValue\": \"untitled\",\n        \"RightValue\": \"SomeTitle\"\n    },\n    {\n        \"Path\": \"breadCrumb.heading.title\",\n        \"LeftValue\": \"Untitled\",\n        \"RightValue\": \"cool heading\"\n    },\n    {\n        \"Path\": \"breadCrumb.heading.secondaryTitle\",\n        \"LeftValue\": \"SecondTitle\",\n        \"RightValue\": null\n    },\n    {\n        \"Path\": \"toolbar\",\n        \"LeftValue\": null,\n        \"RightValue\": {\n            \"Id\": \"t1\",\n            \"toolbarName\": \"Fancy Toolbar\"\n        }\n    }\n]\n}");

            var left = JToken.Parse(objParsed["left"].ToString());

            var selected = JToken.Parse(objParsed["selected"].ToString());
            var userSelectedDifferences = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Difference>>(selected.ToString());


            // Merge the JSON objects based on the user-selected differences
            JToken result = new JsonComparer().Merge(left, userSelectedDifferences);



            JToken expectedResult =JToken.Parse("{\"Id\":1,\"widgetManager\":{\"Id\":\"widgetManager1\",\"layout\":\"13\",\"widgets\":[{\"Id\":\"widget-16784476843\",\"title\":\"A\",\"behaviour\":{\"Id\":\"000\",\"isVisible\":true,\"isDraggable\":\"yes\"}},{\"Id\":\"widget-000000001\",\"title\":\"Should GetMerged\",\"behaviour\":{\"Id\":\"behaviour1\",\"isVisible\":true,\"isDraggable\":\"no\",\"extraPropertyInLeft\":\"yep i am extra\"}},{\"Id\":\"widget-22224476843\",\"title\":\"B\",\"behaviour\":{\"Id\":\"behaviour2\",\"isVisible\":true,\"isDraggable\":\"no\"}}]},\"children\":[{\"isVisible\":true,\"type\":\"text\",\"Id\":\"widget-16784476843-field-16784479250\",\"label\":\"New Field Name\",\"behaviour\":{\"Id\":\"behavior1\",\"autoRender\":true},\"attributes\":{\"Id\":\"attributes1\",\"disable\":false,\"textAlign\":\"right\"}}],\"breadCrumb\":{\"Id\":\"breadCrumb1\",\"navigation\":{\"Id\":\"navigation1\",\"sections\":[{\"Id\":\"sections1\",\"routePath\":\"#\",\"title\":\"SomeTitle\",\"emitEvent\":false}]},\"heading\":{\"Id\":\"heading1\",\"title\":\"cool heading\",\"secondaryTitle\":null}},\"toolbar\":{\"Id\":\"t1\",\"toolbarName\":\"Fancy Toolbar\"}}");
            // Assert
             Assert.True(JToken.DeepEquals(result, expectedResult), "The result of the merge is incorrect.");

        }
        [Fact]
        public void TestMergeComplex2()
        {
            // has all selections except one  "children:widget-16784476843-field-16784479250.attributes.textAlign" 
            // Arrange
            var objParsed = JObject.Parse("{\n      \"left\":{\n    \"Id\": 1,\n    \"widgetManager\": {\n        \"Id\": \"widgetManager1\",\n        \"layout\": \"12\",\n        \"widgets\": [\n            {\n                \"Id\": \"widget-16784476843\",\n                \"title\": \"First\",\n                \"behaviour\": {\n                    \"Id\": \"000\",\n                    \"isVisible\": true,\n                    \"isDraggable\": \"yes\"\n                }\n            },\n            {\n                \"Id\": \"widget-000000001\",\n                \"title\": \"Should GetMerged\",\n                \"behaviour\": {\n                    \"Id\": \"behaviour1\",\n                    \"isVisible\": true,\n                    \"isDraggable\": \"no\",\n                    \"extraPropertyInLeft\": \"yep i am extra\"\n                }\n            }\n        ]\n    },\n    \"children\": [\n        {\n            \"isVisible\": true,\n            \"type\": \"text\",\n            \"Id\": \"widget-16784476843-field-16784479250\",\n            \"label\": \"Field Name\",\n            \"behaviour\": {\n                \"Id\": \"behavior1\",\n                \"autoRender\": false\n            },\n            \"attributes\": {\n                \"Id\": \"attributes1\",\n                \"disable\": false,\n                \"textAlign\": \"left\"\n            }\n        }\n    ],\n    \"breadCrumb\": {\n        \"Id\": \"breadCrumb1\",\n        \"navigation\": {\n            \"Id\": \"navigation1\",\n            \"sections\": [\n                {\n                    \"Id\": \"sections1\",\n                    \"routePath\": \"#\",\n                    \"title\": \"untitled\",\n                    \"emitEvent\": false\n                }\n            ]\n        },\n        \"heading\": {\n            \"Id\": \"heading1\",\n            \"title\": \"Untitled\",\n            \"secondaryTitle\": \"SecondTitle\"\n        }\n    }\n},\n    \"selected\":[\n    {\n        \"Path\": \"widgetManager.layout\",\n        \"LeftValue\": \"12\",\n        \"RightValue\": \"13\"\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-16784476843.title\",\n        \"LeftValue\": \"First\",\n        \"RightValue\": \"A\"\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-000000001\",\n        \"LeftValue\": {\n            \"Id\": \"widget-000000001\",\n            \"title\": \"Should GetMerged\",\n            \"behaviour\": {\n                \"Id\": \"behaviour1\",\n                \"isVisible\": true,\n                \"isDraggable\": \"no\",\n                \"extraPropertyInLeft\": \"yep i am extra\"\n            }\n        },\n        \"RightValue\": null\n    },\n    {\n        \"Path\": \"widgetManager.widgets:widget-22224476843\",\n        \"LeftValue\": null,\n        \"RightValue\": {\n            \"Id\": \"widget-22224476843\",\n            \"title\": \"B\",\n            \"behaviour\": {\n                \"Id\": \"behaviour2\",\n                \"isVisible\": true,\n                \"isDraggable\": \"no\"\n            }\n        }\n    },\n    {\n        \"Path\": \"children:widget-16784476843-field-16784479250.label\",\n        \"LeftValue\": \"Field Name\",\n        \"RightValue\": \"New Field Name\"\n    },\n    {\n        \"Path\": \"children:widget-16784476843-field-16784479250.behaviour.autoRender\",\n        \"LeftValue\": false,\n        \"RightValue\": true\n    },\n    \n    {\n        \"Path\": \"breadCrumb.navigation.sections:sections1.title\",\n        \"LeftValue\": \"untitled\",\n        \"RightValue\": \"SomeTitle\"\n    },\n    {\n        \"Path\": \"breadCrumb.heading.title\",\n        \"LeftValue\": \"Untitled\",\n        \"RightValue\": \"cool heading\"\n    },\n    {\n        \"Path\": \"breadCrumb.heading.secondaryTitle\",\n        \"LeftValue\": \"SecondTitle\",\n        \"RightValue\": null\n    },\n    {\n        \"Path\": \"toolbar\",\n        \"LeftValue\": null,\n        \"RightValue\": {\n            \"Id\": \"t1\",\n            \"toolbarName\": \"Fancy Toolbar\"\n        }\n    }\n]\n}");

            var left = JToken.Parse(objParsed["left"].ToString());

            var selected = JToken.Parse(objParsed["selected"].ToString());
            var userSelectedDifferences = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Difference>>(selected.ToString());


            // Merge the JSON objects based on the user-selected differences
            JToken result = new JsonComparer().Merge(left, userSelectedDifferences);



            JToken expectedResult = JToken.Parse("{\"Id\":1,\"widgetManager\":{\"Id\":\"widgetManager1\",\"layout\":\"13\",\"widgets\":[{\"Id\":\"widget-16784476843\",\"title\":\"A\",\"behaviour\":{\"Id\":\"000\",\"isVisible\":true,\"isDraggable\":\"yes\"}},{\"Id\":\"widget-000000001\",\"title\":\"Should GetMerged\",\"behaviour\":{\"Id\":\"behaviour1\",\"isVisible\":true,\"isDraggable\":\"no\",\"extraPropertyInLeft\":\"yep i am extra\"}},{\"Id\":\"widget-22224476843\",\"title\":\"B\",\"behaviour\":{\"Id\":\"behaviour2\",\"isVisible\":true,\"isDraggable\":\"no\"}}]},\"children\":[{\"isVisible\":true,\"type\":\"text\",\"Id\":\"widget-16784476843-field-16784479250\",\"label\":\"New Field Name\",\"behaviour\":{\"Id\":\"behavior1\",\"autoRender\":true},\"attributes\":{\"Id\":\"attributes1\",\"disable\":false,\"textAlign\":\"left\"}}],\"breadCrumb\":{\"Id\":\"breadCrumb1\",\"navigation\":{\"Id\":\"navigation1\",\"sections\":[{\"Id\":\"sections1\",\"routePath\":\"#\",\"title\":\"SomeTitle\",\"emitEvent\":false}]},\"heading\":{\"Id\":\"heading1\",\"title\":\"cool heading\",\"secondaryTitle\":null}},\"toolbar\":{\"Id\":\"t1\",\"toolbarName\":\"Fancy Toolbar\"}}");
            // Assert
            Assert.True(JToken.DeepEquals(result, expectedResult), "The result of the merge is incorrect.");

        }
    }
}
